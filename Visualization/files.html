<!DOCTYPE html>
<html>
  <head>
    <title>FILES</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <!-- Link to Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
  </head>

  <body>
    <nav class="navbar">
      <div class="navcontainer">
        <div class="navbaritems">
          <ul class="navbar_nav">
            <li class="header">
              <h1>FILES</h1>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="slider.html"> SLIDER </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="files.html"> FILES </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div id="files-container">
      <label for="file-chooser">CHOOSE A FILE:</label>

      <select name="file-chooser" id="file-chooser">
        <!-- <option selected disabled>Pick a file ...</option> -->
        <option value="/Visualization/files/L9xx12xx-TL2068.1b.pdf">L9xx12xx-TL2068.1b</option>
        <option value="/Visualization/files/L9xx0527-TL2027.1a.pdf">L9xx0527-TL2027.1a</option>
        <option value="/Visualization/files/L9xxxxxx-TL0234.1b.pdf">L9xxxxxx-TL0234.1b</option>
        <option value="/Visualization/files/L9xxxxxx-TL2026.1b.pdf">L9xxxxxx-TL2026.1b</option>
      </select>
      <div class="three-blocks">
        <div id="pdf-viewer-div" class="block">
          <iframe id="pdf-viewer" width="100%" height="100%" frameborder="0"> </iframe>
        </div>
        <div id="transcription-viewer" class="block">
          <p id="transcription-text-field" align="center">Test</p>
        </div>
        <div id="paper" class="block"></div>
      </div>

      <!-- Karte -->
      <div id="map-div">
        <div
          id="map"
          class="leaflet-container leaflet-touch leaflet-fade-anim leaflet-grab leaflet-touch-drag leaflet-touch-zoom"
          tabindex="0"
        ></div>
      </div>
    </div>
  </body>

  <!-- Links to joint dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.4.1/backbone.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jointjs/3.7.4/joint.js"></script>

  <!-- Links to leaflet dependencies -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

  <!-- JAVASCRIPT OWN CODE -->
  <script type="text/javascript">
    //
    // FILECHOOSER EVENT LISTENER
    //

    // get the drop down menu
    let fileChooser = document.getElementById("file-chooser");

    // get the pdf viewer
    let pdfViewer = document.getElementById("pdf-viewer");

    // get the transcription text field
    let transcriptionTextField = document.getElementById("transcription-text-field");

    // add event listener to drop down menu
    fileChooser.addEventListener("change", function () {
      // change the pdf if drop down menu selection changed
      pdfViewer.src = this.value;

      // change value to fit filename of txt file
      txtPath = this.value.replaceAll(".", "_") + ".txt";

      // read file
      fetch(txtPath)
        .then((res) => res.text())
        .then((text) => {
          // change value of text field
          transcriptionTextField.textContent = text;
        })
        .catch((e) => console.error(e));

      // change value to fit filename of txt file
      kgPath = this.value.replaceAll(".", "-").replace("pdf", "kg") + ".txt";

      // change graph
      addGraph(kgPath);
    });

    //
    // LEAFLET MAP
    //

    // create the map and set the view
    var map = L.map("map").setView([40, -44], 3);

    L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(map);

    // adds a marker with a pop up to the map
    function addMarker(lat, long, name) {
      L.marker([lat, long]).addTo(map).bindPopup(name).openPopup();
    }

    //
    // GRAPH VISULIZATION
    //

    // create graph
    var graph = new joint.dia.Graph();

    // size of paper
    width = 300;
    height = 700;

    // create paper where graph is displayed
    var paper = new joint.dia.Paper({
      el: document.getElementById("paper"),
      width: width,
      height: height,
      model: graph,
      defaultConnectionPoint: { name: "boundary" },
      defaultConnector: { name: "smooth" },
      interactive: { linkMove: false },
      labelsLayer: true,
      frozen: true,
    });

    // scale (zoom) of graph in paper
    paper.scale(0.6, 0.6);

    // Prevent user from moving the element when interacting with the label element
    paper.on("element:label:pointerdown", function (_view, evt) {
      evt.stopPropagation();
    });

    paper.on("cell:pointerdown blank:pointerdown", function () {
      if (window.getSelection) {
        window.getSelection().removeAllRanges();
      } else if (document.selection) {
        document.selection.empty();
      }
    });

    // function to create a node in the graph
    function node(x, y, label) {
      var node = new joint.shapes.standard.Rectangle({
        position: { x: x, y: y },
        size: { width: 170, height: 60 },
        attrs: {
          label: {
            text: label,
            event: "element:label:pointerdown",
            fontWeight: "bold",
            cursor: "text",
            style: {
              userSelect: "text",
            },
          },
          body: {
            rx: 5, // curve edges
            ry: 5, // curve edges
            strokeWidth: 2, // width of border
          },
        },
      });
      return node.addTo(graph);
    }

    // function create an edge in the graph
    function edge(source, target, label, vertices) {
      var edge = new joint.shapes.standard.Link({
        source: { id: source.id },
        target: { id: target.id },
        attrs: {
          line: {
            strokeWidth: 2,
          },
        },
        labels: [
          {
            position: {
              distance: 0.5,
              offset: label.indexOf("\n") > -1 || label.length === 1 ? 0 : 10,
              args: {
                keepGradient: true,
                ensureLegibility: true,
              },
            },
            attrs: {
              text: {
                text: label,
                fontWeight: "bold",
              },
            },
          },
        ],
        vertices: vertices || [],
      });
      return edge.addTo(graph);
    }

    // changes the graph based on the selected file
    function addGraph(path) {
      // remove the old graph
      graph.clear();

      // read the file
      fetch(path)
        .then((res) => res.text())
        .then((text) => {
          console.log(text);

          // split the text into lines
          let textSplit = text.split(".");

          // get the name of the letter and create nodeOne
          let nodeMainName = path.slice(21, 39);
          let nodeMain = node(width / 2, height / 2, nodeMainName);

          let previousNode;

          // create the nodes and edges
          for (let i = 0; i < textSplit.length - 1; i++) {
            let lineSplit = textSplit[i].split(" ");
            let edgeName = lineSplit[1].replace("ex:", "");
            let nodeName = lineSplit[2].replace("ex:", "");

            // set the height and width of the node
            // TODO besser machen mit Kreis und so
            NodeHeight = 0 + 100 * (i + 1);
            NodeWidth = 0 + 100 * (i + 1);

            // don't show the coordinates node
            if (edgeName != "coordinates") {
              // create node
              nodeX = node(NodeHeight, NodeWidth, nodeName);

              // connect the wikidataQID with the previous node and not the main node
              if (edgeName == "wikidataQID") {
                // wikidataQID connection
                edge(previousNode, nodeX, edgeName);
              } else {
                // normal connection
                edge(nodeMain, nodeX, edgeName);
              }

              // save the previous node in case it needs to be connected to the wikidataQID
              previousNode = nodeX;
            } else {
              let nodeNameSplit = nodeName.split("-");
              let lat = nodeNameSplit[0].replace(",", ".").replace("'", "");
              let long = nodeNameSplit[1].replace(",", ".").replace("'", "");
              let EntityName = lineSplit[0].replace("ex:", "");
              addMarker(lat, long, EntityName);
            }
          }
        })
        .catch((e) => console.error(e));
    }

    // "Update the views of an async paper to make sure that the views reflect the cells' models; unfreeze the paper afterward."
    paper.unfreeze();
  </script>
</html>
